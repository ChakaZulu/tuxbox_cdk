diff -urN linux-2.4.22/Makefile linux-2.4.22-dbox2/Makefile
--- linux-2.4.22/Makefile	Wed Jul 30 13:36:13 2003
+++ linux-2.4.22-dbox2/Makefile	Wed Jul 30 13:37:33 2003
@@ -1,7 +1,7 @@
 VERSION = 2
 PATCHLEVEL = 4
 SUBLEVEL = 22
-EXTRAVERSION =
+EXTRAVERSION = -dbox2
 
 KERNELRELEASE=$(VERSION).$(PATCHLEVEL).$(SUBLEVEL)$(EXTRAVERSION)
 
diff -urN linux-2.4.22/arch/ppc/Makefile linux-2.4.22-dbox2/arch/ppc/Makefile
--- linux-2.4.22/arch/ppc/Makefile	Wed Jul 30 13:36:28 2003
+++ linux-2.4.22-dbox2/arch/ppc/Makefile	Wed Jul 30 13:37:33 2003
@@ -30,7 +30,11 @@
 endif
 
 ifdef CONFIG_8xx
-CFLAGS := $(CFLAGS) -mcpu=860
+  ifdef CONFIG_DBOX2
+    CFLAGS := $(CFLAGS) -mcpu=823
+  else
+    CFLAGS := $(CFLAGS) -mcpu=860
+  endif
 endif
 
 ifdef CONFIG_PPC64BRIDGE
diff -urN linux-2.4.22/arch/ppc/boot/simple/embed_config.c linux-2.4.22-dbox2/arch/ppc/boot/simple/embed_config.c
--- linux-2.4.22/arch/ppc/boot/simple/embed_config.c	Wed Jul 30 13:36:28 2003
+++ linux-2.4.22-dbox2/arch/ppc/boot/simple/embed_config.c	Wed Jul 30 13:37:34 2003
@@ -755,3 +755,11 @@
 }
 #endif
 
+#ifdef CONFIG_DBOX2
+/* dbox2
+ * doesn't do anything right now */
+void
+embed_config(bd_t **bdp)
+{
+}
+#endif
diff -urN linux-2.4.22/arch/ppc/config.in linux-2.4.22-dbox2/arch/ppc/config.in
--- linux-2.4.22/arch/ppc/config.in	Wed Jul 30 13:36:28 2003
+++ linux-2.4.22-dbox2/arch/ppc/config.in	Wed Jul 30 13:38:21 2003
@@ -73,6 +73,7 @@
 	 RPX-Classic	CONFIG_RPXCLASSIC	\
 	 BSE-IP		CONFIG_BSEIP		\
 	 FADS		CONFIG_FADS		\
+	 D-BOX2		CONFIG_DBOX2		\
 	 TQM823L	CONFIG_TQM823L		\
 	 TQM850L	CONFIG_TQM850L		\
 	 TQM855L	CONFIG_TQM855L		\
diff -urN linux-2.4.22/arch/ppc/kernel/irq.c linux-2.4.22-dbox2/arch/ppc/kernel/irq.c
--- linux-2.4.22/arch/ppc/kernel/irq.c	Wed Jul 30 13:36:28 2003
+++ linux-2.4.22-dbox2/arch/ppc/kernel/irq.c	Wed Jul 30 13:37:34 2003
@@ -507,6 +507,14 @@
 		else if (irq_desc[irq].handler->enable)
 			irq_desc[irq].handler->enable(irq);
 	}
+	
+#ifdef CONFIG_DBOX2
+	if (action) {
+	    if (action->flags & SA_ONESHOT)
+		disable_irq_nosync(irq);
+	}
+#endif
+
 	spin_unlock(&desc->lock);
 }
 
diff -urN linux-2.4.22/arch/ppc/kernel/m8xx_setup.c linux-2.4.22-dbox2/arch/ppc/kernel/m8xx_setup.c
--- linux-2.4.22/arch/ppc/kernel/m8xx_setup.c	Wed Jul 30 13:36:28 2003
+++ linux-2.4.22-dbox2/arch/ppc/kernel/m8xx_setup.c	Wed Jul 30 13:37:34 2003
@@ -117,6 +117,22 @@
 	printk ("timebase_interrupt()\n");
 }
 
+#ifdef CONFIG_DBOX2
+void m8xx_reset_watchdog(void)
+{
+	((volatile immap_t *)IMAP_ADDR)->im_siu_conf.sc_swsr = 0x556c;             /* write magic1 */
+	((volatile immap_t *)IMAP_ADDR)->im_siu_conf.sc_swsr = 0xaa39;             /* write magic2 */
+}
+
+void pit_interrupt(int irq, void * dev, struct pt_regs * regs)
+{
+	m8xx_reset_watchdog();
+
+	// Clear irq
+	((volatile immap_t *)IMAP_ADDR)->im_sit.sit_piscr |= PISCR_PS;
+}
+#endif
+
 /* The decrementer counts at the system (internal) clock frequency divided by
  * sixteen, or external oscillator divided by four.  We force the processor
  * to use system clock divided by sixteen.
@@ -126,6 +142,11 @@
 	bd_t	*binfo = (bd_t *)__res;
 	int freq, fp, divisor;
 
+#ifdef CONFIG_DBOX2
+	unsigned long sypcr;
+	unsigned short pitc, swtc, swp;
+#endif	
+
 	/* Unlock the SCCR. */
 	((volatile immap_t *)IMAP_ADDR)->im_clkrstk.cark_sccrk = ~KAPWR_KEY;
 	((volatile immap_t *)IMAP_ADDR)->im_clkrstk.cark_sccrk = KAPWR_KEY;
@@ -133,6 +154,18 @@
 	/* Force all 8xx processors to use divide by 16 processor clock. */
 	((volatile immap_t *)IMAP_ADDR)->im_clkrst.car_sccr |= 0x02000000;
 
+#ifdef CONFIG_DBOX2
+	if ((binfo->bi_intfreq < 1000000) || (binfo->bi_busfreq < 1000000)) {
+	    printk("WARNING: Frequency is not in HZ. Please consider using a newer bootloader!\n");
+	    printk("WARNING: OLD intfreq = %d busfreq = %d\n", binfo->bi_intfreq, binfo->bi_busfreq);
+
+	    binfo->bi_intfreq *= 1000000;
+	    binfo->bi_busfreq *= 1000000;
+
+	    printk("WARNING: NEW intfreq = %d busfreq = %d\n", binfo->bi_intfreq, binfo->bi_busfreq);
+	}
+#endif
+
 	/* Processor frequency is MHz.
 	 * The value 'fp' is the number of decrementer ticks per second.
 	 */
@@ -184,6 +217,41 @@
 	if (request_irq(DEC_INTERRUPT, timebase_interrupt, 0, "tbint",
 				NULL) != 0)
 		panic("Could not allocate timer IRQ!");
+
+#ifdef CONFIG_DBOX2
+	sypcr = ((volatile immap_t *)IMAP_ADDR)->im_siu_conf.sc_sypcr;
+
+	if ((sypcr >> 2) & 0x1) {
+	    m8xx_reset_watchdog();
+	
+	    if (sypcr >> 16)
+		swtc = sypcr >> 16;
+	    else	
+		swtc = 0xFFFF;
+
+	    if (sypcr & 0x1)
+		swp = 2048;
+	    else
+		swp = 1;
+
+#define PITRTCLK 8192
+
+	    // Fire trigger if half of the wdt ticked down		
+	    if ((swp * swtc) > (UINT_MAX / PITRTCLK))
+		pitc = swtc * swp / binfo->bi_intfreq * PITRTCLK / 2;
+	    else
+		pitc = PITRTCLK * swtc * swp / binfo->bi_intfreq / 2;
+	    
+	    ((volatile immap_t *)IMAP_ADDR)->im_sit.sit_pitc = pitc << 16;
+	    ((volatile immap_t *)IMAP_ADDR)->im_sit.sit_piscr = (mk_int_int_mask(PIT_INTERRUPT) << 8) | PISCR_PIE | PISCR_PTE;
+	
+	    if (request_8xxirq(PIT_INTERRUPT, pit_interrupt, 0, "pit", NULL) != 0)
+		    panic("mpc8xx-wdt: could not allocate pit irq!");
+
+	    printk(KERN_INFO "mpc8xx-wdt: active wdt found (SWTC: 0x%04X, SWP: 0x%01X)\n", sypcr >> 16, sypcr & 0x1);
+	    printk(KERN_INFO "mpc8xx-wdt: keep-alive trigger activated (PITC: 0x%04X)\n", pitc);
+	}
+#endif
 }
 
 /* The RTC on the MPC8xx is an internal register.
diff -urN linux-2.4.22/arch/ppc/kernel/ppc_ksyms.c linux-2.4.22-dbox2/arch/ppc/kernel/ppc_ksyms.c
--- linux-2.4.22/arch/ppc/kernel/ppc_ksyms.c	Fri Jun 13 16:51:31 2003
+++ linux-2.4.22-dbox2/arch/ppc/kernel/ppc_ksyms.c	Wed Jul 30 13:37:34 2003
@@ -343,6 +343,10 @@
 EXPORT_SYMBOL(cpm_install_handler);
 EXPORT_SYMBOL(cpm_free_handler);
 EXPORT_SYMBOL(m8xx_cpm_hostalloc);
+#ifdef CONFIG_DBOX2
+EXPORT_SYMBOL(m8xx_cpm_setbrg);
+EXPORT_SYMBOL(m8xx_cpm_dpalloc);
+#endif /* CONFIG_DBOX2 */
 #endif /* CONFIG_8xx */
 
 /* Those should really be inline */
diff -urN linux-2.4.22/arch/ppc/kernel/time.c linux-2.4.22-dbox2/arch/ppc/kernel/time.c
--- linux-2.4.22/arch/ppc/kernel/time.c	Wed Jul 30 13:36:29 2003
+++ linux-2.4.22-dbox2/arch/ppc/kernel/time.c	Wed Jul 30 13:39:03 2003
@@ -71,6 +71,10 @@
 
 extern int do_sys_settimeofday(struct timeval *tv, struct timezone *tz);
 
+#ifdef CONFIG_DBOX2
+extern void m8xx_reset_watchdog(void);
+#endif
+
 /* keep track of when we need to update the rtc */
 time_t last_rtc_update;
 extern rwlock_t xtime_lock;
@@ -320,6 +324,9 @@
 		sec = ppc_md.get_rtc_time();
 		elapsed = 0;
 		do {
+#ifdef CONFIG_DBOX2
+			m8xx_reset_watchdog();
+#endif
 			old_stamp = stamp;
 			old_sec = sec;
 			stamp = get_native_tbl();
diff -urN linux-2.4.22/arch/ppc/platforms/dbox2.h linux-2.4.22-dbox2/arch/ppc/platforms/dbox2.h
--- linux-2.4.22/arch/ppc/platforms/dbox2.h	Thu Jan  1 01:00:00 1970
+++ linux-2.4.22-dbox2/arch/ppc/platforms/dbox2.h	Wed Jul 30 13:37:34 2003
@@ -0,0 +1,24 @@
+/*
+ * D-BOX2 board specific definitions
+ * 
+ * Copyright (c) 2001-2002 Florian Schirmer (jolt@tuxbox.org)
+ */
+
+#ifndef __MACH_DBOX2_H
+#define __MACH_DBOX2_H
+
+#include <linux/config.h>
+ 
+#include <asm/ppcboot.h>
+
+#define	DBOX2_IMMR_BASE	0xFF000000	/* phys. addr of IMMR */
+#define	DBOX2_IMAP_SIZE	(64 * 1024)	/* size of mapped area */
+
+#define	IMAP_ADDR	DBOX2_IMMR_BASE	/* physical base address of IMMR area */
+#define IMAP_SIZE	DBOX2_IMAP_SIZE	/* mapped size of IMMR area */
+
+/* We don't use the 8259.
+*/
+#define NR_8259_INTS	0
+
+#endif	/* __MACH_DBOX2_H */
diff -urN linux-2.4.22/drivers/char/console.c linux-2.4.22-dbox2/drivers/char/console.c
--- linux-2.4.22/drivers/char/console.c	Fri Nov 29 00:53:12 2002
+++ linux-2.4.22-dbox2/drivers/char/console.c	Wed Jul 30 13:37:34 2003
@@ -110,7 +110,11 @@
 #include "console_macros.h"
 
 
-const struct consw *conswitchp;
+#ifdef CONFIG_DUMMY_CONSOLE
+const struct consw *conswitchp = &dummy_con;
+#else
+const struct consw *conswitchp = 0;
+#endif
 
 /* A bitmap for codes <32. A bit of 1 indicates that the code
  * corresponding to that bit number invokes some special action
diff -urN linux-2.4.22/drivers/char/vt.c linux-2.4.22-dbox2/drivers/char/vt.c
--- linux-2.4.22/drivers/char/vt.c	Fri Nov 29 00:53:12 2002
+++ linux-2.4.22-dbox2/drivers/char/vt.c	Wed Jul 30 13:37:34 2003
@@ -93,7 +93,8 @@
 #if defined(__i386__) || defined(__alpha__) || defined(CONFIG_PPC_ISATIMER) \
     || (defined(__mips__) && defined(CONFIG_ISA)) \
     || (defined(__arm__) && defined(CONFIG_HOST_FOOTBRIDGE)) \
-    || defined(__x86_64__)
+    || defined(__x86_64__) \
+    || (defined(__powerpc__) && !defined(CONFIG_DBOX2))
 
 static void
 kd_nosound(unsigned long ignored)
diff -urN linux-2.4.22/drivers/input/keybdev.c linux-2.4.22-dbox2/drivers/input/keybdev.c
--- linux-2.4.22/drivers/input/keybdev.c	Wed Jul 30 13:36:45 2003
+++ linux-2.4.22-dbox2/drivers/input/keybdev.c	Wed Jul 30 13:37:34 2003
@@ -108,7 +108,11 @@
 #endif	/* CONFIG_MAC_ADBKEYCODES || CONFIG_ADB_KEYBOARD */
 
 	if (keycode > 255 || !x86_keycodes[keycode])
+#ifdef CONFIG_DBOX2
+		return 0; 
+#else
 		return -1; 
+#endif
 
 	if (keycode == KEY_PAUSE) {
 		handle_scancode(0xe1, 1);
diff -urN linux-2.4.22/drivers/video/Config.in linux-2.4.22-dbox2/drivers/video/Config.in
--- linux-2.4.22/drivers/video/Config.in	Fri Jun 13 16:51:37 2003
+++ linux-2.4.22-dbox2/drivers/video/Config.in	Wed Jul 30 13:37:34 2003
@@ -248,6 +248,7 @@
       tristate '    VGA 16-color planar support' CONFIG_FBCON_VGA_PLANES
       tristate '    VGA characters/attributes support' CONFIG_FBCON_VGA
       tristate '    HGA monochrome support (EXPERIMENTAL)' CONFIG_FBCON_HGA
+      bool '    console shift' CONFIG_FBCON_SHIFT 0
    else
       # Guess what we need
       if [ "$CONFIG_FB_ACORN" = "y" -o "$CONFIG_FB_AMIGA" = "y" -o \
diff -urN linux-2.4.22/drivers/video/fbcon-cfb16.c linux-2.4.22-dbox2/drivers/video/fbcon-cfb16.c
--- linux-2.4.22/drivers/video/fbcon-cfb16.c	Mon Oct 15 22:47:13 2001
+++ linux-2.4.22-dbox2/drivers/video/fbcon-cfb16.c	Wed Jul 30 13:37:34 2003
@@ -46,6 +46,12 @@
     int bytes = p->next_line, linesize = bytes * fontheight(p), rows;
     u8 *src, *dst;
 
+#ifdef CONFIG_FBCON_SHIFT
+    width += p->shift_x;
+    dy += p->shift_y;
+    sy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     if (sx == 0 && dx == 0 && width * fontwidth(p) * 2 == bytes) {
 	fb_memmove(p->screen_base + dy * linesize,
 		  p->screen_base + sy * linesize,
@@ -108,6 +114,11 @@
     int bytes = p->next_line, lines = height * fontheight(p);
     u32 bgx;
 
+#ifdef CONFIG_FBCON_SHIFT
+    sx += p->shift_x;
+    sy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest = p->screen_base + sy * fontheight(p) * bytes + sx * fontwidth(p) * 2;
 
     bgx = ((u16 *)p->dispsw_data)[attr_bgcol_ec(p, conp)];
@@ -126,6 +137,11 @@
     int bytes = p->next_line, rows;
     u32 eorx, fgx, bgx;
 
+#ifdef CONFIG_FBCON_SHIFT
+    xx += p->shift_x;
+    yy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest = p->screen_base + yy * fontheight(p) * bytes + xx * fontwidth(p) * 2;
 
     fgx = ((u16 *)p->dispsw_data)[attr_fgcol(p, c)];
@@ -177,6 +193,11 @@
     int rows, bytes = p->next_line;
     u32 eorx, fgx, bgx;
 
+#ifdef CONFIG_FBCON_SHIFT
+    xx += p->shift_x;
+    yy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest0 = p->screen_base + yy * fontheight(p) * bytes + xx * fontwidth(p) * 2;
     c = scr_readw(s);
     fgx = ((u16 *)p->dispsw_data)[attr_fgcol(p, c)];
@@ -233,6 +254,11 @@
     u8 *dest;
     int bytes = p->next_line, rows;
 
+#ifdef CONFIG_FBCON_SHIFT
+    xx += p->shift_x;
+    yy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest = p->screen_base + yy * fontheight(p) * bytes + xx * fontwidth(p)*2;
     for (rows = fontheight(p); rows--; dest += bytes) {
 	switch (fontwidth(p)) {
@@ -261,18 +287,31 @@
     int bytes = p->next_line;
     u32 bgx;
 
+#ifndef CONFIG_FBCON_SHIFT
     unsigned int right_start = conp->vc_cols*fontwidth(p);
     unsigned int bottom_start = conp->vc_rows*fontheight(p);
     unsigned int right_width, bottom_width;
+#endif /* CONFIG_FBCON_SHIFT */
 
     bgx = ((u16 *)p->dispsw_data)[attr_bgcol_ec(p, conp)];
 
+#ifndef CONFIG_FBCON_SHIFT
     if (!bottom_only && (right_width = p->var.xres-right_start))
 	rectfill(p->screen_base+right_start*2, right_width,
 		 p->var.yres_virtual, bgx, bytes);
     if ((bottom_width = p->var.yres-bottom_start))
 	rectfill(p->screen_base+(p->var.yoffset+bottom_start)*bytes,
 		 right_start, bottom_width, bgx, bytes);
+#else /* CONFIG_FBCON_SHIFT */
+    rectfill(p->screen_base, p->var.xres_virtual,
+	     p->shift_y*fontheight(p), bgx, bytes);
+    rectfill(p->screen_base, p->shift_x*fontwidth(p),
+	     p->var.yres_virtual, bgx, bytes);
+    rectfill(p->screen_base+(conp->vc_cols+p->shift_x)*fontwidth(p)*2, p->shift_x*fontwidth(p),
+	     p->var.yres_virtual, bgx, bytes);
+    rectfill(p->screen_base+(conp->vc_rows+p->shift_y)*fontheight(p)*bytes, p->var.xres_virtual,
+	     p->shift_y*fontheight(p), bgx, bytes);
+#endif /* CONFIG_FBCON_SHIFT */
 }
 
 
diff -urN linux-2.4.22/drivers/video/fbcon-cfb8.c linux-2.4.22-dbox2/drivers/video/fbcon-cfb8.c
--- linux-2.4.22/drivers/video/fbcon-cfb8.c	Mon Oct 15 22:47:13 2001
+++ linux-2.4.22-dbox2/drivers/video/fbcon-cfb8.c	Wed Jul 30 13:37:34 2003
@@ -51,6 +51,12 @@
     int bytes = p->next_line, linesize = bytes * fontheight(p), rows;
     u8 *src,*dst;
 
+#ifdef CONFIG_FBCON_SHIFT
+    width += p->shift_x;
+    dy += p->shift_y;
+    sy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     if (sx == 0 && dx == 0 && width * fontwidth(p) == bytes) {
 	fb_memmove(p->screen_base + dy * linesize,
 		  p->screen_base + sy * linesize,
@@ -97,6 +103,11 @@
     int bytes=p->next_line,lines=height * fontheight(p);
     u8 bgx;
 
+#ifdef CONFIG_FBCON_SHIFT
+    sx += p->shift_x;
+    sy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest = p->screen_base + sy * fontheight(p) * bytes + sx * fontwidth(p);
 
     bgx=attr_bgcol_ec(p,conp);
@@ -115,6 +126,11 @@
     int bytes=p->next_line,rows;
     u32 eorx,fgx,bgx;
 
+#ifdef CONFIG_FBCON_SHIFT
+    xx += p->shift_x;
+    yy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest = p->screen_base + yy * fontheight(p) * bytes + xx * fontwidth(p);
     if (fontwidth(p) <= 8)
 	cdat = p->fontdata + (c & p->charmask) * fontheight(p);
@@ -162,6 +178,11 @@
     int rows,bytes=p->next_line;
     u32 eorx, fgx, bgx;
 
+#ifdef CONFIG_FBCON_SHIFT
+    xx += p->shift_x;
+    yy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest0 = p->screen_base + yy * fontheight(p) * bytes + xx * fontwidth(p);
     c = scr_readw(s);
     fgx = attr_fgcol(p, c);
@@ -219,6 +240,11 @@
     u8 *dest;
     int bytes=p->next_line, rows;
 
+#ifdef CONFIG_FBCON_SHIFT
+    xx += p->shift_x;
+    yy += p->shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
+
     dest = p->screen_base + yy * fontheight(p) * bytes + xx * fontwidth(p);
     for (rows = fontheight(p) ; rows-- ; dest += bytes) {
     	switch (fontwidth(p)) {
@@ -237,18 +263,31 @@
     int bytes=p->next_line;
     u8 bgx;
 
+#ifndef CONFIG_FBCON_SHIFT
     unsigned int right_start = conp->vc_cols*fontwidth(p);
     unsigned int bottom_start = conp->vc_rows*fontheight(p);
     unsigned int right_width, bottom_width;
+#endif /* CONFIG_FBCON_SHIFT */
 
     bgx=attr_bgcol_ec(p,conp);
 
+#ifndef CONFIG_FBCON_SHIFT
     if (!bottom_only && (right_width = p->var.xres-right_start))
 	rectfill(p->screen_base+right_start, right_width, p->var.yres_virtual,
 		 bgx, bytes);
     if ((bottom_width = p->var.yres-bottom_start))
 	rectfill(p->screen_base+(p->var.yoffset+bottom_start)*bytes,
 		 right_start, bottom_width, bgx, bytes);
+#else /* CONFIG_FBCON_SHIFT */
+    rectfill(p->screen_base, p->var.xres_virtual,
+             p->shift_y*fontheight(p), bgx, bytes);
+    rectfill(p->screen_base, p->shift_x*fontwidth(p),
+             p->var.yres_virtual, bgx, bytes);
+    rectfill(p->screen_base+(conp->vc_cols+p->shift_x)*fontwidth(p), p->shift_x*fontwidth(p),
+             p->var.yres_virtual, bgx, bytes);
+    rectfill(p->screen_base+(conp->vc_rows+p->shift_y)*fontheight(p)*bytes, p->var.xres_virtual,
+             p->shift_y*fontheight(p), bgx, bytes);
+#endif /* CONFIG_FBCON_SHIFT */
 }
 
 
diff -urN linux-2.4.22/drivers/video/fbcon.c linux-2.4.22-dbox2/drivers/video/fbcon.c
--- linux-2.4.22/drivers/video/fbcon.c	Wed Jul 30 13:37:09 2003
+++ linux-2.4.22-dbox2/drivers/video/fbcon.c	Wed Jul 30 13:37:34 2003
@@ -655,8 +655,13 @@
     old_cols = conp->vc_cols;
     old_rows = conp->vc_rows;
     
+#ifdef CONFIG_FBCON_SHIFT
+    nr_cols = p->var.xres/fontwidth(p) - 2*p->shift_x;
+    nr_rows = p->var.yres/fontheight(p) - 2*p->shift_y;
+#else /* CONFIG_FBCON_SHIFT */
     nr_cols = p->var.xres/fontwidth(p);
     nr_rows = p->var.yres/fontheight(p);
+#endif /* CONFIG_FBCON_SHIFT */
     
     if (logo) {
     	/* Need to make room for the logo */
diff -urN linux-2.4.22/include/asm-ppc/commproc.h linux-2.4.22-dbox2/include/asm-ppc/commproc.h
--- linux-2.4.22/include/asm-ppc/commproc.h	Wed Jul 30 13:37:23 2003
+++ linux-2.4.22-dbox2/include/asm-ppc/commproc.h	Wed Jul 30 13:37:34 2003
@@ -466,6 +466,24 @@
 #define SICR_ENET_CLKRT	((uint)0x0000003d)
 #endif	/* CONFIG_RPXCLASSIC */
 
+/***  D-BOX2  ***********************************************/
+
+#ifdef CONFIG_DBOX2
+
+#define PA_ENET_RXD	((ushort)0x0004)	
+#define PA_ENET_TXD	((ushort)0x0008)	
+#define PA_ENET_RCLK	((ushort)0x0200)	
+#define PA_ENET_TCLK	((ushort)0x0800)	
+
+#define PC_ENET_TENA	((ushort)0x0002)
+
+#define PC_ENET_CLSN	((ushort)0x0040)	
+#define PC_ENET_RENA	((ushort)0x0080)	
+
+#define SICR_ENET_MASK	((uint)0x0000ff00)
+#define SICR_ENET_CLKRT	((uint)0x00003d00)
+#endif	/* CONFIG_DBOX2 */
+
 /***  TQM823L, TQM850L  ***********************************************/
 
 #if defined(CONFIG_TQM823L) || defined(CONFIG_TQM850L)
diff -urN linux-2.4.22/include/asm-ppc/mpc8xx.h linux-2.4.22-dbox2/include/asm-ppc/mpc8xx.h
--- linux-2.4.22/include/asm-ppc/mpc8xx.h	Fri Jun 13 16:51:38 2003
+++ linux-2.4.22-dbox2/include/asm-ppc/mpc8xx.h	Wed Jul 30 13:37:34 2003
@@ -32,6 +32,10 @@
 #include <platforms/rpxclassic.h>
 #endif
 
+#ifdef CONFIG_DBOX2
+#include <platforms/dbox2.h>
+#endif
+
 #if defined(CONFIG_TQM8xxL)
 #include <platforms/tqm8xx.h>
 #endif
diff -urN linux-2.4.22/include/linux/fb.h linux-2.4.22-dbox2/include/linux/fb.h
--- linux-2.4.22/include/linux/fb.h	Fri Jun 13 16:51:38 2003
+++ linux-2.4.22-dbox2/include/linux/fb.h	Wed Jul 30 13:37:34 2003
@@ -108,6 +108,9 @@
 #define FB_ACCEL_NEOMAGIC_NM2360 97	/* NeoMagic NM2360              */
 #define FB_ACCEL_NEOMAGIC_NM2380 98	/* NeoMagic NM2380              */
 
+#define FB_ACCEL_CCUBE_AVIA_GTX	120	/* C-Cube AViA GTX		*/
+#define FB_ACCEL_CCUBE_AVIA_ENX	121	/* C-Cube AViA eNX		*/
+
 
 struct fb_fix_screeninfo {
 	char id[16];			/* identification string eg "TT Builtin" */
diff -urN linux-2.4.22/include/linux/input.h linux-2.4.22-dbox2/include/linux/input.h
--- linux-2.4.22/include/linux/input.h	Fri Jun 13 16:51:38 2003
+++ linux-2.4.22-dbox2/include/linux/input.h	Wed Jul 30 13:37:34 2003
@@ -310,6 +310,77 @@
 #define KEY_BRIGHTNESSDOWN	224
 #define KEY_BRIGHTNESSUP	225
 
+#define KEY_OK           0x160
+#define KEY_SELECT       0x161
+#define KEY_GOTO         0x162
+#define KEY_CLEAR        0x163
+#define KEY_POWER2       0x164
+#define KEY_OPTION       0x165
+#define KEY_INFO         0x166
+#define KEY_TIME         0x167
+#define KEY_VENDOR       0x168
+#define KEY_ARCHIVE      0x169
+#define KEY_PROGRAM      0x16a
+#define KEY_CHANNEL      0x16b
+#define KEY_FAVORITES    0x16c
+#define KEY_EPG          0x16d
+#define KEY_PVR          0x16e
+#define KEY_MHP          0x16f
+#define KEY_LANGUAGE     0x170
+#define KEY_TITLE        0x171
+#define KEY_SUBTITLE     0x172
+#define KEY_ANGLE        0x173
+#define KEY_ZOOM         0x174
+#define KEY_MODE         0x175
+#define KEY_KEYBOARD     0x176
+#define KEY_SCREEN       0x177
+#define KEY_PC           0x178
+#define KEY_TV           0x179
+#define KEY_TV2          0x17a
+#define KEY_VCR          0x17b
+#define KEY_VCR2         0x17c
+#define KEY_SAT          0x17d
+#define KEY_SAT2         0x17e
+#define KEY_CD           0x17f
+#define KEY_TAPE         0x180
+#define KEY_RADIO        0x181
+#define KEY_TUNER        0x182
+#define KEY_PLAYER       0x183
+#define KEY_TEXT         0x184
+#define KEY_DVD          0x185
+#define KEY_AUX          0x186
+#define KEY_MP3          0x187
+#define KEY_AUDIO        0x188
+#define KEY_VIDEO        0x189
+#define KEY_DIRECTORY    0x18a
+#define KEY_LIST         0x18b
+#define KEY_MEMO         0x18c
+#define KEY_CALENDAR     0x18d
+#define KEY_RED          0x18e
+#define KEY_GREEN        0x18f
+#define KEY_YELLOW       0x190
+#define KEY_BLUE         0x191
+#define KEY_CHANNELUP    0x192
+#define KEY_CHANNELDOWN  0x193
+#define KEY_FIRST        0x194
+#define KEY_LAST         0x195
+#define KEY_AB           0x196
+#define KEY_PLAY         0x197
+#define KEY_RESTART      0x198
+#define KEY_SLOW         0x199
+#define KEY_SHUFFLE      0x19a
+#define KEY_FASTFORWARD  0x19b
+#define KEY_PREVIOUS     0x19c
+#define KEY_NEXT         0x19d
+#define KEY_DIGITS       0x19e
+#define KEY_TEEN         0x19f
+#define KEY_TWEN         0x1a0
+#define KEY_BREAK        0x1a1
+#define KEY_TOPLEFT      0x1a2
+#define KEY_TOPRIGHT     0x1a3
+#define KEY_BOTTOMLEFT   0x1a4
+#define KEY_BOTTOMRIGHT  0x1a5
+
 #define BTN_MISC		0x100
 #define BTN_0			0x100
 #define BTN_1			0x101
diff -urN linux-2.4.22/include/video/fbcon.h linux-2.4.22-dbox2/include/video/fbcon.h
--- linux-2.4.22/include/video/fbcon.h	Wed Jul 30 13:37:27 2003
+++ linux-2.4.22-dbox2/include/video/fbcon.h	Wed Jul 30 13:37:34 2003
@@ -95,6 +95,11 @@
     short yscroll;                  /* Hardware scrolling */
     unsigned char fgshift, bgshift;
     unsigned short charmask;        /* 0xff or 0x1ff */
+
+#ifdef CONFIG_FBCON_SHIFT
+    int shift_x;
+    int shift_y;
+#endif /* CONFIG_FBCON_SHIFT */
 };
 
 /* drivers/video/fbcon.c */
